<!-- Add Supabase client in <head> -->
<head>
  <!-- ...existing head code... -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://hombfzdgmtbbaahglclv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhvbWJmemRnbXRiYmFhaGdsY2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NTk5MzcsImV4cCI6MjA2NzIzNTkzN30.j9fdl-oYCYUbRigNFmzriKKrFNZTqG5h9hPXdJmbRWQ'
    );
  </script>
</head>

<!-- ...existing body code... -->

<script>
// ...existing code above...

// Replace Formspree submission with Supabase logic
// Find the booking form submit handler and replace fetch('https://formspree.io/f/mqabjjyb', ...) with:

bookingForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  // ...existing validation and data collection code...

  // 1. Insert into orders
  let orderInsert = {
    customer_name: name,
    customer_email: email,
    customer_phone: phone,
    address: address,
    notes: document.getElementById('notes').value.trim(),
    order_status: 'pending',
    scheduled_date: null, // You can set this if you collect it
    scheduled_window: null, // You can set this if you collect it
    promo_code: state.promo ? state.promo.code : null,
    deposit_amount: deposit,
    balance_due: balance,
    created_at: new Date().toISOString(),
  };
  let { data: order, error: orderError } = await supabase
    .from('orders')
    .insert([orderInsert])
    .select()
    .single();
  if (orderError) {
    alert('Error saving order: ' + orderError.message);
    return;
  }

  // 2. Insert each service into order_service
  for (const service of servicesData) {
    let serviceInsert = {
      order_id: order.id,
      service_type: service.service,
      status: 'pending',
      scheduled_time: null, // Set if you collect it
      price_estimate: service.price || service.total || 0,
      created_at: new Date().toISOString(),
    };
    let { data: orderService, error: serviceError } = await supabase
      .from('order_service')
      .insert([serviceInsert])
      .select()
      .single();
    if (serviceError) {
      alert('Error saving service: ' + serviceError.message);
      return;
    }
    // 3. Insert service-specific details
    if (service.service === 'Home Cleaning') {
      await supabase.from('order_cleaning_details').insert([{
        order_service_id: orderService.id,
        bedrooms_count: service.bedrooms,
        bathrooms_count: service.bathrooms,
        estimated_price: service.total,
        adding: service.addons ? JSON.stringify(service.addons) : null,
        notes: order.notes,
        created_at: new Date().toISOString(),
      }]);
    }
    if (service.service === 'Laundry') {
      await supabase.from('order_laundry_bags').insert([{
        order_service_id: orderService.id,
        bag_type: service.bagType,
        quantity: service.quantity,
        estimated_price: service.price,
        notes: order.notes,
        created_at: new Date().toISOString(),
      }]);
    }
    if (service.service === 'Car Wash') {
      await supabase.from('order_vehicles').insert([{
        order_service_id: orderService.id,
        vehicle_type: service.type,
        tier: service.tier,
        estimated_price: service.price,
        addons: service.addons ? JSON.stringify(service.addons) : null,
        notes: order.notes,
        created_at: new Date().toISOString(),
      }]);
    }
  }

  // On success, show Stripe payment link as before
  if ([20, 30, 50, 65, 75].includes(deposit)) {
    const stripeLinks = {
      20: 'https://buy.stripe.com/test_aFa6oG7ZDcGBaUp7vb6kg00',
      30: 'https://buy.stripe.com/test_00wcN493H8qlgeJbLr6kg01',
      50: 'https://buy.stripe.com/test_4gM3cu1Bf6ide6BdTz6kg02',
      65: 'https://buy.stripe.com/test_6oU8wO4NrgWR2nT6r76kg05',
      75: 'https://buy.stripe.com/test_4gM9AS93H6id8MhbLr6kg06'
    };
    const stripeUrl = stripeLinks[deposit];
    window.open(stripeUrl, '_blank');
    alert('Your booking has been submitted! Please complete your deposit payment in the new tab.');
  } else {
    alert('Thank you for your booking request! We will contact you soon to confirm your appointment.');
  }

  // Reset form and state
  bookingForm.reset();
  state = {
    activeService: 'carwash',
    selectedServices: ['carwash'],
    carwash: [],
    homeclean: {tier:'refreshed', bedrooms:0, bathrooms:0, addons:[], deepbedCount: 0},
    laundry: {
      essentials: {qty: 0, newKits: 0, replacements: 0},
      family: {qty: 0, newKits: 0, replacements: 0},
      delicates: {qty: 0, newKits: 0, replacements: 0},
      ironing: {qty: 0, newKits: 0, replacements: 0},
      addons: []
    },
    promo: null
  };
  renderServiceSections();
});
// ...rest of your script...
</script> 